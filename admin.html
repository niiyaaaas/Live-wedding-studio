<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | LiveWedding Studio</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Supabase CDN Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- LiveWedding Cloud Client -->
    <script src="supabase-client.js"></script>

    <style>
        :root {
            --bg-darker: #050505;
            --bg-card: #141414;
            --gold-primary: #d4af37;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --font-sans: 'Outfit', sans-serif;
            --border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-sans);
        }

        body {
            background-color: var(--bg-darker);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 30px 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            text-align: center;
            margin-bottom: 40px;
            letter-spacing: 1px;
            font-family: 'Cormorant Garamond', serif;
        }

        .logo span {
            color: var(--gold-primary);
        }

        .nav-link {
            padding: 15px 30px;
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold-primary);
            border-right: 4px solid var(--gold-primary);
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 600;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        /* Grid Layouts */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--gold-primary);
        }

        /* Advanced AI Panel Mockup */
        .ai-panel {
            background: var(--bg-card);
            border: 1px solid var(--gold-primary);
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .ai-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-actions {
            display: flex;
            gap: 20px;
        }

        .ai-btn {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold-primary);
            border: 1px solid var(--gold-primary);
            padding: 15px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .ai-btn:hover {
            background: var(--gold-primary);
            color: var(--bg-darker);
        }

        /* Tables */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 25px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th,
        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 400;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status.completed {
            background: rgba(37, 211, 102, 0.1);
            color: #25D366;
        }

        .status.processing {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold-primary);
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="logo">LiveWedding <span>Admin</span></div>
        <a href="#" class="nav-link active" data-target="dashboard"><i class="fas fa-home"></i> Dashboard</a>
        <a href="#" class="nav-link" data-target="bookings"><i class="fas fa-calendar-check"></i> Bookings</a>
        <a href="#" class="nav-link" data-target="gallery"><i class="fas fa-images"></i> Gallery Manager</a>
        <a href="#" class="nav-link" data-target="ai-edit"><i class="fas fa-magic"></i> AI Auto-Edit</a>
        <a href="#" class="nav-link" data-target="clients"><i class="fas fa-users"></i> Client Access</a>
        <a href="#" class="nav-link" data-target="staff"><i class="fas fa-user-shield"></i> Staff Management</a>
        <a href="#" class="nav-link" data-target="analytics"><i class="fas fa-chart-line"></i> Analytics</a>
        <a href="#" class="nav-link" style="margin-top: auto; color: #ff4d4d;" id="admin-logout"><i
                class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main-content">
        <header class="header">
            <h1 class="header-title">Welcome back, Arjun</h1>
            <div class="user-profile">
                <span>Super Admin</span>
                <i class="fas fa-user-circle" style="font-size: 2rem; color: var(--gold-primary);"></i>
            </div>
        </header>

        <div id="view-dashboard" class="spa-view">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">New Bookings (This Month)</div>
                    <div class="stat-value">12</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Storage Used (AWS S3)</div>
                    <div class="stat-value">8.4 TB</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Active Client Galleries</div>
                    <div class="stat-value">45</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Revenue (YTD)</div>
                    <div class="stat-value">₹4.2 Cr</div>
                </div>
            </div>

            <div class="table-container">
                <h2 class="panel-title" style="font-size: 1.3rem; margin-bottom: 20px;">Recent Events Processing Status
                </h2>
                <table>
                    <thead>
                        <tr>
                            <th>Client / Event</th>
                            <th>Photos Uploaded</th>
                            <th>AI Edit Status</th>
                            <th>Gallery Access PIN</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Aiswarya & Rahul</strong><br><span
                                    style="color:#aaa; font-size: 0.85rem;">Destination Wedding</span></td>
                            <td>4,500 RAW</td>
                            <td>Color grading complete. AI sorting pending.</td>
                            <td style="font-family: monospace; letter-spacing: 2px;">AR8025X</td>
                            <td><span class="status processing">Processing AI</span></td>
                        </tr>
                        <tr>
                            <td><strong>Maya & Karthik</strong><br><span
                                    style="color:#aaa; font-size: 0.85rem;">Pre-Wedding
                                    Shoot</span></td>
                            <td>850 RAW</td>
                            <td>Presets applied. Retouched.</td>
                            <td style="font-family: monospace; letter-spacing: 2px;">MK3392Z</td>
                            <td><span class="status completed">Delivered</span></td>
                        </tr>
                        <tr>
                            <td><strong>Priya & Rohan</strong><br><span style="color:#aaa; font-size: 0.85rem;">Goa
                                    Beach
                                    Wedding</span></td>
                            <td>6,200 RAW</td>
                            <td>Uploading to S3...</td>
                            <td style="color:#aaa;">Pending</td>
                            <td><span class="status processing">Uploading</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-analytics" class="spa-view" style="display: none;">
            <!-- Graphical Analytics Representation -->
            <div class="ai-panel" style="padding: 20px;">
                <div class="panel-title" style="display: flex; justify-content: space-between;">
                    <div><i class="fas fa-chart-bar" style="color: var(--gold-primary);"></i> Revenue & Booking
                        Analytics</div>
                    <div>
                        <button class="ai-btn" style="padding: 5px 15px; font-size: 0.8rem;"
                            id="btn-monthly">Monthly</button>
                        <button class="ai-btn"
                            style="padding: 5px 15px; font-size: 0.8rem; background: var(--bg-card); border-color: var(--border); color: var(--text-secondary);"
                            id="btn-yearly">Yearly</button>
                    </div>
                </div>
                <div style="height: 400px; width: 100%;">
                    <canvas id="analyticsChart"></canvas>
                </div>
            </div>
        </div>

        <div id="view-ai-edit" class="spa-view" style="display: none;">
            <div class="ai-panel">
                <div class="panel-title"><i class="fas fa-brain" style="color: var(--gold-primary);"></i> AI Workflow
                    Engine
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">Automate repetitive processes using custom
                    AI
                    presets.</p>

                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; border-top: 1px solid var(--border); padding-top: 30px;">
                    <!-- Auto-Edit Simulation -->
                    <div>
                        <h3 style="margin-bottom: 15px; font-size: 1.2rem;">Live Auto-Edit Simulator</h3>
                        <div style="background: var(--bg-darker); border: 1px dashed var(--gold-primary); height: 250px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border-radius: 4px;"
                            id="editor-canvas-container">
                            <img id="editor-img"
                                src="https://images.unsplash.com/photo-1519225421980-715cb0215aed?auto=format&fit=crop&q=80&w=800"
                                style="max-height: 100%; max-width: 100%; object-fit: contain; transition: filter 0.5s ease;">
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                            <button class="ai-btn" style="padding: 10px 15px; font-size: 0.8rem;"
                                onclick="applyPreset('none')">Original RAW</button>
                            <button class="ai-btn" style="padding: 10px 15px; font-size: 0.8rem;"
                                onclick="applyPreset('cinematic')">Cinematic Kerala</button>
                            <button class="ai-btn" style="padding: 10px 15px; font-size: 0.8rem;"
                                onclick="applyPreset('vintage')">Vintage Film</button>
                            <button class="ai-btn" style="padding: 10px 15px; font-size: 0.8rem;"
                                onclick="applyPreset('bnw')">High-Contrast B&W</button>
                        </div>
                    </div>

                    <!-- Manual Upload & Train -->
                    <div>
                        <h3 style="margin-bottom: 15px; font-size: 1.2rem;">Batch Processing & Models</h3>
                        <div class="ai-actions" style="flex-direction: column;">
                            <button class="ai-btn"><i class="fas fa-sliders-h"></i> Sync Lightroom Profiles
                                (.xmp)</button>
                            <button class="ai-btn"><i class="fas fa-user-tag"></i> Train Face Recognition DB</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-gallery" class="spa-view" style="display: none;">
            <div class="ai-panel">
                <div class="panel-title"><i class="fas fa-images" style="color: var(--gold-primary);"></i> Gallery
                    Upload Manager</div>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">Upload high-resolution event files
                    securely to AWS S3 storage.</p>

                <!-- Pre-Upload Meta Form -->
                <div id="upload-meta-form"
                    style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 25px;">
                    <h4 style="margin-bottom: 15px; color: var(--gold-primary);">Step 1: Event Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label
                                style="display:block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem;">Select
                                Client ID</label>
                            <select id="upload-client-select"
                                style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                                <option value="" disabled selected>-- Choose Client from DB --</option>
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label
                                style="display:block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem;">Event
                                Name/Category</label>
                            <input type="text" id="upload-event-name" placeholder="e.g. Haldi, Reception, Engagement"
                                style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                        </div>
                    </div>
                </div>

                <div style="border: 2px dashed var(--border); padding: 50px; text-align: center; border-radius: 8px; margin-bottom: 20px;"
                    id="upload-dropzone">
                    <i class="fas fa-cloud-upload-alt"
                        style="font-size: 3rem; color: var(--gold-primary); margin-bottom: 15px;"></i>
                    <h3 style="margin-bottom: 10px;">Step 2: Drag & Drop files here</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">or click to browse from your computer
                    </p>
                    <button class="ai-btn" style="margin: 0 auto;" onclick="triggerUploadValidation()">Select
                        Files</button>
                    <input type="file" id="mockUploadActual" multiple style="display:none;"
                        onchange="startMockUpload(this.files)">
                </div>

                <div id="upload-progress-container" style="display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem;">
                        <span id="upload-status-text">Uploading files...</span>
                        <span id="upload-percentage">0%</span>
                    </div>
                    <div
                        style="width: 100%; height: 8px; background: var(--bg-darker); border-radius: 4px; overflow: hidden;">
                        <div id="upload-progress-bar"
                            style="width: 0%; height: 100%; background: var(--gold-primary); transition: width 0.3s ease;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <h3 style="margin-bottom: 15px;">Uploaded Gallery Files</h3>
                <table id="gallery-files-table">
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Size</th>
                            <th>Upload Date</th>
                            <th>Status/Info</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="gallery-table-body">
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-secondary);">No files uploaded
                                in this session.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-clients" class="spa-view" style="display: none;">
            <div class="table-container" style="margin-bottom: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="panel-title" style="margin-bottom: 0;">Client Access Management</h2>
                    <button class="ai-btn" style="padding: 10px 20px;"
                        onclick="document.getElementById('new-client-form-container').style.display='block'">+ New
                        Client Access</button>
                </div>

                <div id="new-client-form-container"
                    style="display:none; background: var(--bg-darker); padding: 25px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px;">
                    <form id="new-client-form" onsubmit="createNewClient(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;">Client
                                    ID (username)</label>
                                <input type="text" id="new-client-id" required
                                    style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                            </div>
                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;">Access
                                    PIN</label>
                                <input type="text" id="new-client-pin" required
                                    style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                            </div>
                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;">Display
                                    Names</label>
                                <input type="text" id="new-client-name" required placeholder="John & Jane"
                                    style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                            </div>
                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;">Event
                                    Date</label>
                                <input type="text" id="new-client-date" required placeholder="e.g. Dec 12, 2025"
                                    style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button type="submit" class="ai-btn" style="padding: 10px 20px;">Save Client</button>
                            <button type="button" class="ai-btn"
                                style="padding: 10px 20px; background: transparent; border-color: var(--border); color: var(--text-secondary);"
                                onclick="document.getElementById('new-client-form-container').style.display='none'">Cancel</button>
                        </div>
                    </form>
                </div>

                <table id="clients-table">
                    <thead>
                        <tr>
                            <th>Client ID</th>
                            <th>Names</th>
                            <th>Event Date</th>
                            <th>PIN</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body">
                        <!-- Populated via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-bookings" class="spa-view" style="display: none;">
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="panel-title" style="margin-bottom: 0;">Manage CRM Bookings</h2>
                    <button class="ai-btn" style="padding: 10px 20px;"
                        onclick="document.getElementById('new-booking-form-container').style.display='block'">+ Add
                        Manual Event</button>
                </div>

                <div id="new-booking-form-container"
                    style="display:none; background: var(--bg-darker); padding: 25px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px;">
                    <form id="new-booking-form" onsubmit="createManualBooking(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;">Client
                                    Name</label>
                                <input type="text" id="manual-book-name" required
                                    style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                            </div>
                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;">Event
                                    Date</label>
                                <input type="date" id="manual-book-date" required
                                    style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button type="submit" class="ai-btn" style="padding: 10px 20px;">Save Event</button>
                            <button type="button" class="ai-btn"
                                style="padding: 10px 20px; background: transparent; border-color: var(--border); color: var(--text-secondary);"
                                onclick="document.getElementById('new-booking-form-container').style.display='none'">Cancel</button>
                        </div>
                    </form>
                </div>

                <table id="bookings-table">
                    <thead>
                        <tr>
                            <th>Inquiry Name</th>
                            <th>Email</th>
                            <th>Event Date</th>
                            <th>Package Interest</th>
                            <th>Status/Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookings-table-body">
                        <!-- Populated via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-staff" class="spa-view" style="display: none;">
            <div class="table-container" style="margin-bottom: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="panel-title" style="margin-bottom: 0;">Staff & Admin Role Management</h2>
                    <button class="ai-btn" style="padding: 10px 20px;"
                        onclick="document.getElementById('new-staff-form-container').style.display='block'">+ Create
                        Staff Account</button>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">Superadmins have full control. Staff
                    accounts are restricted to Gallery Uploading and AI Auto-Edit tasks only.</p>

                <div id="new-staff-form-container"
                    style="display:none; background: var(--bg-darker); padding: 25px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px;">
                    <form id="new-staff-form" onsubmit="createNewStaff(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;">Username</label>
                                <input type="text" id="new-staff-user" required
                                    style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                            </div>
                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;">Password</label>
                                <input type="text" id="new-staff-pass" required
                                    style="width: 100%; background: transparent; border: 1px solid var(--border); padding: 10px; color: white; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button type="submit" class="ai-btn" style="padding: 10px 20px;">Save Account</button>
                            <button type="button" class="ai-btn"
                                style="padding: 10px 20px; background: transparent; border-color: var(--border); color: var(--text-secondary);"
                                onclick="document.getElementById('new-staff-form-container').style.display='none'">Cancel</button>
                        </div>
                    </form>
                </div>

                <table id="staff-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Clearance Level</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staff-table-body">
                        <!-- Populated via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Auth & External Libraries -->
    <script src="auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let analyticsChartInstance = null;

        document.addEventListener('DOMContentLoaded', function () {
            // --- SPA NAVIGATION LOGIC ---
            const navLinks = document.querySelectorAll('.nav-link[data-target]');
            const views = document.querySelectorAll('.spa-view');
            const headerTitle = document.querySelector('.header-title');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();

                    // Remove active from all links and views
                    navLinks.forEach(l => l.classList.remove('active'));
                    views.forEach(v => v.style.display = 'none');

                    // Activate target
                    link.classList.add('active');
                    const targetId = link.getAttribute('data-target');
                    document.getElementById(`view-${targetId}`).style.display = 'block';

                    // Update header title based on view
                    const viewTitles = {
                        'dashboard': 'Welcome back, ' + localStorage.getItem('admin_logged_in_user'),
                        'analytics': 'Revenue Analytics',
                        'ai-edit': 'AI Workflow Engine',
                        'gallery': 'Gallery Upload Manager',
                        'clients': 'Client Access Manager',
                        'staff': 'Staff & Admin Management',
                        'bookings': 'CRM & Bookings'
                    };
                    headerTitle.innerText = viewTitles[targetId];

                    // Render chart dynamically only when analytics tab is opened if not initialized
                    if (targetId === 'analytics' && !analyticsChartInstance) {
                        initChart();
                    }

                    // Load client data if client view
                    if (targetId === 'clients') {
                        renderClientsTable();
                    }

                    // Load staff data if staff view
                    if (targetId === 'staff') {
                        renderStaffTable();
                    }

                    // Load bookings data if bookings view
                    if (targetId === 'bookings') {
                        renderBookingsTable();
                    }
                });
            });

            // Restrict Sidebar UI on load based on role (safety check if auth.js UI logic missed it)
            if (localStorage.getItem('admin_logged_in_role') !== 'superadmin') {
                const clientsTab = document.querySelector('.nav-link[data-target="clients"]');
                if (clientsTab) clientsTab.style.display = 'none';
                const staffAdminTab = document.querySelector('.nav-link[data-target="staff"]');
                if (staffAdminTab) staffAdminTab.style.display = 'none';
            }

            // Initialize Dashboard View
            document.getElementById('view-dashboard').style.display = 'block';

            // --- CHART LOGIC ---
            function initChart() {
                const ctx = document.getElementById('analyticsChart');
                if (ctx) {
                    analyticsChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: getChartData('monthly'),
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#a0a0a0' } }
                            },
                            scales: {
                                y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a0a0a0' } },
                                x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a0a0a0' } }
                            }
                        }
                    });
                }
            }

            function getChartData(period) {
                if (period === 'monthly') {
                    return {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
                        datasets: [
                            {
                                label: 'Revenue (Lakhs ₹)',
                                data: [15, 19, 25, 22, 30, 28, 35, 32, 40, 42],
                                borderColor: '#d4af37', backgroundColor: 'rgba(212, 175, 55, 0.1)', borderWidth: 3, fill: true, tension: 0.4
                            },
                            {
                                label: 'Bookings',
                                data: [4, 5, 8, 6, 9, 8, 12, 10, 14, 12],
                                borderColor: '#ffffff', backgroundColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4
                            }
                        ]
                    };
                } else { // Yearly
                    return {
                        labels: ['2020', '2021', '2022', '2023', '2024'],
                        datasets: [
                            {
                                label: 'Revenue (Lakhs ₹)',
                                data: [120, 180, 250, 310, 420],
                                borderColor: '#d4af37', backgroundColor: 'rgba(212, 175, 55, 0.1)', borderWidth: 3, fill: true, tension: 0.4
                            },
                            {
                                label: 'Bookings',
                                data: [45, 60, 95, 110, 140],
                                borderColor: '#ffffff', backgroundColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4
                            }
                        ]
                    };
                }
            }

            // Chart Toggle Event Listeners
            document.getElementById('btn-monthly')?.addEventListener('click', (e) => {
                e.target.style.background = 'rgba(212, 175, 55, 0.1)';
                e.target.style.borderColor = 'var(--gold-primary)';
                e.target.style.color = 'var(--gold-primary)';
                document.getElementById('btn-yearly').style.background = 'var(--bg-card)';
                document.getElementById('btn-yearly').style.borderColor = 'var(--border)';
                document.getElementById('btn-yearly').style.color = 'var(--text-secondary)';

                if (analyticsChartInstance) {
                    analyticsChartInstance.data = getChartData('monthly');
                    analyticsChartInstance.update();
                }
            });

            document.getElementById('btn-yearly')?.addEventListener('click', (e) => {
                e.target.style.background = 'rgba(212, 175, 55, 0.1)';
                e.target.style.borderColor = 'var(--gold-primary)';
                e.target.style.color = 'var(--gold-primary)';
                document.getElementById('btn-monthly').style.background = 'var(--bg-card)';
                document.getElementById('btn-monthly').style.borderColor = 'var(--border)';
                document.getElementById('btn-monthly').style.color = 'var(--text-secondary)';

                if (analyticsChartInstance) {
                    analyticsChartInstance.data = getChartData('yearly');
                    analyticsChartInstance.update();
                }
            });

            // Render Initial Clients
            renderClientsTable();
        });

        // --- AI PRESET LOGIC ---
        function applyPreset(type) {
            const img = document.getElementById('editor-img');
            document.querySelectorAll('#view-ai-edit .ai-btn').forEach(b => {
                b.style.background = 'rgba(212, 175, 55, 0.1)';
                b.style.color = 'var(--gold-primary)';
            });
            event.target.style.background = 'var(--gold-primary)';
            event.target.style.color = 'var(--bg-darker)';

            switch (type) {
                case 'cinematic': img.style.filter = 'contrast(1.2) saturate(1.1) sepia(0.2) brightness(0.9)'; break;
                case 'vintage': img.style.filter = 'sepia(0.4) contrast(0.9) hue-rotate(-10deg) saturate(0.8)'; break;
                case 'bnw': img.style.filter = 'grayscale(1) contrast(1.4) brightness(0.9)'; break;
                case 'none': default: img.style.filter = 'none'; break;
            }
        }

        // --- MOCK UPLOAD LOGIC & VALIDATION ---
        function triggerUploadValidation() {
            const clientId = document.getElementById('upload-client-select').value;
            const eventName = document.getElementById('upload-event-name').value;

            if (!clientId) {
                alert("Please select a Client ID from the DB before uploading.");
                return;
            }
            if (!eventName.trim()) {
                alert("Please enter an Event Name/Category (e.g. Haldi).");
                return;
            }

            document.getElementById('mockUploadActual').click();
        }

        function startMockUpload(files) {
            if (!files || files.length === 0) return;

            const dropzone = document.getElementById('upload-dropzone');
            const progressContainer = document.getElementById('upload-progress-container');
            const progressBar = document.getElementById('upload-progress-bar');
            const progressPercent = document.getElementById('upload-percentage');
            const statusText = document.getElementById('upload-status-text');
            const tableBody = document.querySelector('#gallery-files-table tbody');

            // Clear "No files" message if present
            if (tableBody.innerHTML.includes('No files uploaded')) {
                tableBody.innerHTML = '';
            }

            // Hide dropzone, show progress
            dropzone.style.display = 'none';
            progressContainer.style.display = 'block';
            statusText.innerText = `Preparing ${files.length} files...`;

            let progress = 0;
            const uploadInterval = setInterval(() => {
                progress += Math.floor(Math.random() * 15) + 5;
                if (progress > 100) progress = 100;

                progressBar.style.width = `${progress}%`;
                progressPercent.innerText = `${progress}%`;
                statusText.innerText = `Uploading to AWS S3... (${progress}%)`;

                if (progress === 100) {
                    clearInterval(uploadInterval);
                    statusText.innerText = "Upload Complete!";
                    statusText.style.color = "#25D366";

                    // Add items to table
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        dropzone.style.display = 'block';

                        Array.from(files).forEach(file => {
                            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                            const row = document.createElement('tr');

                            const clientId = document.getElementById('upload-client-select').value;
                            const eventName = document.getElementById('upload-event-name').value;

                            row.innerHTML = `
                                <td><i class="fas fa-file-image" style="color:var(--gold-primary); margin-right: 10px;"></i>${file.name}</td>
                                <td>${sizeMB} MB</td>
                                <td>${new Date().toLocaleDateString()}</td>
                                <td><span class="status completed">${clientId} - ${eventName}</span></td>
                                <td>
                                    <button class="ai-btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="alert('Viewing file in isolated modal...')">View</button>
                                    <button class="ai-btn" style="padding: 5px 10px; font-size: 0.8rem; background: rgba(255, 77, 77, 0.1); color: #ff4d4d; border-color: #ff4d4d;" onclick="this.closest('tr').remove(); alert('File removed from cloud database.');">Remove</button>
                                </td>
                            `;
                            tableBody.prepend(row);
                        });

                        // Reset progress
                        progressBar.style.width = '0%';
                        progressPercent.innerText = '0%';
                        statusText.style.color = "var(--text-secondary)";
                        document.getElementById('upload-event-name').value = '';
                    }, 1000);
                }
            }, 300);
        }

        // --- CLIENT CRUD LOGIC ---
        function renderClientsTable() {
            const tableBody = document.getElementById('clients-table-body');
            if (!tableBody) return;

            let clients = JSON.parse(localStorage.getItem('livewedding_clients'));
            if (!clients) {
                // Initialize defaults
                clients = {
                    'aiswarya_rahul': { pin: 'password', names: 'Aiswarya & Rahul', date: 'October 15, 2025' }
                };
                localStorage.setItem('livewedding_clients', JSON.stringify(clients));
            }

            tableBody.innerHTML = '';

            const uploadSelect = document.getElementById('upload-client-select');
            if (uploadSelect) uploadSelect.innerHTML = '<option value="" disabled selected>-- Choose Client from DB --</option>';

            for (const [id, data] of Object.entries(clients)) {

                // Add to client table
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-family: monospace;">${id}</td>
                    <td><strong>${data.names}</strong></td>
                    <td>${data.date}</td>
                    <td style="letter-spacing: 2px;">${data.pin}</td>
                    <td>
                        <button class="ai-btn" style="padding: 5px 10px; font-size: 0.8rem; background: rgba(255, 77, 77, 0.1); color: #ff4d4d; border-color: #ff4d4d;" onclick="deleteClient('${id}')">Revoke Access</button>
                    </td>
                `;
                tableBody.appendChild(row);

                // Populate Dropdown for Upload Manager
                if (uploadSelect) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.text = `${id} (${data.names})`;
                    option.style.background = '#1a1a1a';
                    uploadSelect.appendChild(option);
                }
            }
        }

        function createNewClient(e) {
            e.preventDefault();
            const id = document.getElementById('new-client-id').value;
            const pin = document.getElementById('new-client-pin').value;
            const names = document.getElementById('new-client-name').value;
            const date = document.getElementById('new-client-date').value;

            let clients = JSON.parse(localStorage.getItem('livewedding_clients')) || {};
            clients[id] = { pin, names, date };

            localStorage.setItem('livewedding_clients', JSON.stringify(clients));

            // Reset and refresh
            document.getElementById('new-client-form').reset();
            document.getElementById('new-client-form-container').style.display = 'none';
            renderClientsTable();
            alert(`Client ${names} added successfully! They can now log in at the Client Portal.`);
        }

        function deleteClient(id) {
            if (confirm(`Are you sure you want to revoke access for client ID: ${id}?`)) {
                let clients = JSON.parse(localStorage.getItem('livewedding_clients'));
                delete clients[id];
                localStorage.setItem('livewedding_clients', JSON.stringify(clients));
                renderClientsTable();
            }
        }

        // --- STAFF CRUD LOGIC ---
        function renderStaffTable() {
            const tableBody = document.getElementById('staff-table-body');
            if (!tableBody) return;

            const db = JSON.parse(localStorage.getItem('livewedding_db'));
            if (!db || !db.admins) return;

            tableBody.innerHTML = '';
            db.admins.forEach((admin, index) => {
                const row = document.createElement('tr');
                const clearance = admin.role === 'superadmin' ? 'Full Access' : 'Gallery & AI Only';
                const statusClass = admin.role === 'superadmin' ? 'completed' : 'processing';

                let deleteBtn = '';
                if (admin.role !== 'superadmin') {
                    deleteBtn = `<button class="ai-btn" style="padding: 5px 10px; font-size: 0.8rem; background: rgba(255, 77, 77, 0.1); color: #ff4d4d; border-color: #ff4d4d;" onclick="deleteStaff(${index})">Delete</button>`;
                } else {
                    deleteBtn = `<span style="color: var(--text-secondary); font-size: 0.8rem;">Cannot delete root</span>`;
                }

                row.innerHTML = `
                    <td><strong>${admin.username}</strong></td>
                    <td><span class="status ${statusClass}">${admin.role}</span></td>
                    <td style="color: var(--text-secondary);">${clearance}</td>
                    <td>${deleteBtn}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function createNewStaff(e) {
            e.preventDefault();
            const user = document.getElementById('new-staff-user').value;
            const pass = document.getElementById('new-staff-pass').value;

            let db = JSON.parse(localStorage.getItem('livewedding_db'));

            // Check if exists
            if (db.admins.find(a => a.username === user)) {
                alert("Username already exists!");
                return;
            }

            db.admins.push({ username: user, password: pass, role: 'staff' });
            localStorage.setItem('livewedding_db', JSON.stringify(db));

            document.getElementById('new-staff-form').reset();
            document.getElementById('new-staff-form-container').style.display = 'none';
            renderStaffTable();
            alert(`Staff account '${user}' created successfully.`);
        }

        function deleteStaff(index) {
            let db = JSON.parse(localStorage.getItem('livewedding_db'));
            const staffUser = db.admins[index].username;
            if (confirm(`Are you sure you want to delete staff account: ${staffUser}?`)) {
                db.admins.splice(index, 1);
                localStorage.setItem('livewedding_db', JSON.stringify(db));
                renderStaffTable();
            }
        }

        // --- BOOKINGS CRUD LOGIC ---
        async function renderBookingsTable() {
            const tableBody = document.getElementById('bookings-table-body');
            if (!tableBody) return;

            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--gold-primary);">Loading live cloud data...</td></tr>';

            let bookings = await cloudGetBookings();

            tableBody.innerHTML = '';

            if (bookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--text-secondary);">No active bookings in CRM database.</td></tr>';
                return;
            }

            bookings.forEach((booking) => {
                const row = document.createElement('tr');

                let actionHTML = '';
                // Check if old ID or UUID format for string passing
                const idArg = typeof booking.id === 'string' ? `'${booking.id}'` : booking.id;

                if (booking.status === 'pending') {
                    actionHTML = `
                        <button class="ai-btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateBookingStatus(${idArg}, 'confirmed')">Accept</button>
                        <button class="ai-btn" style="padding: 5px 10px; font-size: 0.8rem; background: rgba(255, 77, 77, 0.1); color: #ff4d4d; border-color: #ff4d4d;" onclick="updateBookingStatus(${idArg}, 'rejected')">Reject</button>
                    `;
                } else if (booking.status === 'confirmed') {
                    actionHTML = `<span class="status completed">Confirmed Event</span>`;
                } else {
                    actionHTML = `<span class="status" style="background: rgba(255, 77, 77, 0.1); color: #ff4d4d;">Rejected</span>`;
                }

                row.innerHTML = `
                    <td><strong>${booking.name}</strong></td>
                    <td>${booking.email || 'N/A'}</td>
                    <td>${new Date(booking.date).toLocaleDateString()}</td>
                    <td>${booking.package}</td>
                    <td>${actionHTML}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function createManualBooking(e) {
            e.preventDefault();
            const name = document.getElementById('manual-book-name').value;
            const date = document.getElementById('manual-book-date').value;

            // Submit direct to Supabase but immediately as 'confirmed'
            const { data, error } = await supabase
                .from('bookings')
                .insert([{ name: name, email: "Manual Entry", date: date, package: "Custom Admin Entry", status: 'confirmed' }]);

            if (error) {
                alert("Error connecting to live CRM. See console.");
                console.error(error);
                return;
            }

            document.getElementById('new-booking-form').reset();
            document.getElementById('new-booking-form-container').style.display = 'none';
            await renderBookingsTable();
            alert('Event booked successfully! This date is now blocked on the live frontend.');
        }

        async function updateBookingStatus(id, newStatus) {
            await cloudUpdateBookingStatus(id, newStatus);
            await renderBookingsTable();
        }
    </script>
</body>

</html>